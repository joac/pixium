<!DOCTYPE html>
<html>
    <head>
        <title>Pixium</title>
        <link id="favicon" rel="icon" type="image/png" href="#" />
        <style type="text/css">
            html,
            body {
                margin: 0;
                height: 100%;
                font-family: Helvetica;
            }
            #container {
                min-width: 320px;
                height: 100%;
            }
            .controls {
                float: left;
                background-color: white;
                width: 420px;
                border: solid 2px gray;
                padding: 6px;
                box-shadow: 0px 6px 13px 0px rgba(50, 50, 50, 0.82);
            }
            .controls .title {
                margin-bottom: 6px;
                font-size: 20px;
            }
            .controls .title small {
                color: gray;
                font-size: 10px;
                margin-left: 4px;
            }
            #pixum {
                display: none;
            }
            #sample,
            #slider {
                widht: 30px;
                height: 360px;
                float: left;
            }
            #selector {
                witdth: 360px;
                height: 360px;
                float: left;
            }
        </style>
    </head>
    <body>
        <div class="controls">
            <div class="title">Pixium<small>Click Anywhere!</small></div>
            <canvas id="slider" width="30px" height="360px"></canvas>
            <canvas id="selector" width="360px" height="360px"></canvas>
            <canvas id="sample" width="30px" height="360px"></canvas>
        </div>
        <div id="container">
            <canvas id="pixum" width="128px" height="128px"></canvas>
        </div>
        <script type="application/javascript">
            document.addEventListener("DOMContentLoaded", () => {
                const component = (name) => {
                    const element = document.getElementById(name),
                        ctx = element.getContext("2d");
                    return { element, ctx };
                };
                const canvas = component("pixum"),
                    slider = component("slider"),
                    selector = component("selector"),
                    sample = component("sample"),
                    container = document.getElementById("container"),
                    favicon = document.getElementById("favicon"),
                    Q = 16,
                    SIZE = 8;
                const gradient = 30;

                const hsl = (h, s = 100, l = 50) => `hsl(${h}, ${s}%, ${l}%)`;

                const state = {
                    previousColors: [],
                    currentColor: undefined,
                };

                const setCurrentColor = (newColor) => {
                    state.currentColor = {
                        ...state.currentColor,
                        ...newColor,
                    };
                    state.previousColors.push(state.currentColor);
                    const { h, s, l } = state.currentColor;
                    canvas.ctx.fillStyle = hsl(h, s, l);
                };

                setCurrentColor({ h: 50, s: 100, l: 50 });
                const data = [];
                for (let x = 0; x < SIZE; x++) {
                    data.push([]);
                    for (let y = 0; y < SIZE; y++) {
                        data[x].push(undefined);
                    }
                }
                const encode = (data) => {
                    const output = [];
                    for (let x = 0; x < SIZE; x++) {
                        for (let y = 0; y < SIZE; y++) {
                            output.push((data[x][y] ?? "-").replace("#", ""));
                        }
                    }
                    return output.join("");
                };
                const decode = (data) => {
                    const output = [];
                    let current = "";
                    for (let i = 0; i < data.length; i++) {
                        if (data[i] === "-") {
                            if (current.length) output.push(current);
                            output.push(undefined);
                            current = "";
                        } else if (current.length === 7) {
                            output.push(current);
                            current = `#${data[i]}`;
                        } else if (current.length === 0) {
                            current = `#${data[i]}`;
                        } else {
                            current += data[i];
                        }
                    }
                    if (current.length) {
                        output.push(current);
                    }
                    return output;
                };
                const fillPixel = (x, y) => {
                    data[x][y] = canvas.ctx.fillStyle;
                    canvas.ctx.fillRect(x * Q, y * Q, Q, Q);
                    const content = canvas.element.toDataURL("image/png", "");
                    document.location.hash = encodeURIComponent(encode(data));
                    container.style["background-image"] = `url(${content})`;
                    document.head.removeChild(favicon);
                    favicon.href = content;
                    document.head.appendChild(favicon);
                };

                if (document.location.hash) {
                    try {
                        const parsed = decode(
                            decodeURIComponent(document.location.hash.slice(1))
                        );
                        console.log(parsed);
                        for (let x = 0; x < SIZE; x++) {
                            for (let y = 0; y < SIZE; y++) {
                                const color = parsed[x * SIZE + y];
                                console.log(x, y, color);
                                if (color) {
                                    canvas.ctx.fillStyle = color;
                                    fillPixel(x, y);
                                }
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Invalid url");
                    }
                }
                const clamp = (v) => Math.floor((v / Q) % SIZE);

                const draw = (e) => {
                    const x = clamp(e.clientX);
                    const y = clamp(e.clientY);
                    fillPixel(x, y);
                };

                container.addEventListener("mousedown", (e) => {
                    if (e.buttons === 1) draw(e);
                });
                container.addEventListener("mousemove", (e) => {
                    if (e.buttons === 1) draw(e);
                });
                container.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    return false;
                });
                // TODO add support for touch devices

                slider.element.addEventListener("mousedown", (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const h = e.clientY - rect.top;
                    setCurrentColor({ h: Math.floor(h / gradient) * gradient });
                    renderPicker();
                });

                const toSLCords = (x, y) => {
                    return {
                        l:
                            100 -
                            ((Math.floor(x / gradient) * gradient) / 360) * 100,
                        s:
                            100 -
                            ((Math.floor(y / gradient) * gradient) / 360) * 100,
                    };
                };

                selector.element.addEventListener("mousedown", (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    setCurrentColor(toSLCords(x, y));
                    renderPicker();
                });

                sample.element.addEventListener("mousedown", (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const slot = Math.floor(y / 30);
                    if (state.previousColors.length > slot) {
                        const retrieved = state.previousColors.at(-(slot + 1));
                        setCurrentColor(retrieved);
                        renderPicker();
                    }
                });
                const renderPicker = () => {
                    for (let i = 0; i < 360; i += gradient) {
                        slider.ctx.fillStyle = hsl(i, 100, 50);
                        slider.ctx.fillRect(0, i, 30, gradient);
                    }
                    for (
                        let n = 0;
                        n < Math.min(12, state.previousColors.length);
                        n++
                    ) {
                        const { h, s, l } =
                            state.previousColors[
                                state.previousColors.length - n - 1
                            ];
                        sample.ctx.fillStyle = hsl(h, s, l);
                        sample.ctx.fillRect(0, n * 30, 30, 30);
                    }
                    for (let x = 0; x < 360; x += gradient) {
                        for (let y = 0; y < 360; y += gradient) {
                            const { s, l } = toSLCords(x, y);
                            selector.ctx.fillStyle = hsl(
                                state.currentColor.h,
                                s,
                                l
                            );
                            selector.ctx.fillRect(x, y, gradient, gradient);
                        }
                    }
                };
                renderPicker();
            });
        </script>
    </body>
</html>
