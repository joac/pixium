<!DOCTYPE html>
<html>
    <head>
        <title>Pixium</title>
        <link id="favicon" rel="icon" type="image/png" href="#" />
        <style type="text/css">
            html,
            body {
                margin: 0;
                height: 100%;
                font-family: Helvetica;
            }
            #container {
                min-width: 320px;
                height: 100%;
            }
            .controls {
                float: left;
                background-color: white;
                width: 420px;
                border: solid 2px gray;
                padding: 6px;
                box-shadow: 0px 6px 13px 0px rgba(50, 50, 50, 0.82);
            }
            .controls .title {
                margin-bottom: 6px;
                font-size: 20px;
            }
            .controls .title small {
                color: gray;
                font-size: 10px;
                margin-left: 4px;
            }
            #pixum {
                display: none;
            }
            #sample,
            #slider {
                widht: 30px;
                height: 360px;
                float: left;
            }
            #selector {
                witdth: 360px;
                height: 360px;
                float: left;
            }
        </style>
    </head>
    <body>
        <div class="controls">
            <div class="title">Pixium<small>Click Anywhere!</small></div>
            <canvas id="slider" width="30px" height="360px"></canvas>
            <canvas id="selector" width="360px" height="360px"></canvas>
            <canvas id="sample" width="30px" height="360px"></canvas>
        </div>
        <div id="container">
            <canvas id="pixum" width="128px" height="128px"></canvas>
        </div>
        <script type="application/javascript">
            document.addEventListener("DOMContentLoaded", () => {
                const component = (name) => {
                    const element = document.getElementById(name),
                        ctx = element.getContext("2d");
                    return { element, ctx };
                };
                const canvas = component("pixum"),
                    slider = component("slider"),
                    selector = component("selector"),
                    sample = component("sample"),
                    container = document.getElementById("container"),
                    favicon = document.getElementById("favicon"),
                    Q = 16,
                    SIZE = 8;
                const gradient = 30;

                const hsl = (h, s = 100, l = 50) => `hsl(${h}, ${s}%, ${l}%)`;

                const state = {
                    previousColors: [],
                    currentColor: undefined,
                };

                const setCurrentColor = (newColor) => {
                    state.currentColor = {
                        ...state.currentColor,
                        ...newColor,
                    };
                    state.previousColors.push(state.currentColor);
                    const { h, s, l } = state.currentColor;
                    canvas.ctx.fillStyle = hsl(h, s, l);
                };

                setCurrentColor({ h: 50, s: 100, l: 50 });

                const fillPixel = (x, y) => {
                    canvas.ctx.fillRect(x * Q, y * Q, Q, Q);
                    const content = canvas.element.toDataURL("image/png", "");
                    container.style["background-image"] = `url(${content})`;
                    document.head.removeChild(favicon);
                    favicon.href = content;
                    document.head.appendChild(favicon);
                };
                const clamp = (v) => Math.floor((v / Q) % SIZE);

                const draw = (e) => {
                    const x = clamp(e.clientX);
                    const y = clamp(e.clientY);
                    fillPixel(x, y);
                };

                container.addEventListener("mousedown", (e) => {
                    if (e.buttons === 1) draw(e);
                });
                container.addEventListener("mousemove", (e) => {
                    if (e.buttons === 1) draw(e);
                });
                container.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    return false;
                });

                slider.element.addEventListener("mousedown", (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const h = e.clientY - rect.top;
                    setCurrentColor({ h: Math.floor(h / gradient) * gradient });
                    renderPicker();
                });

                const toSLCords = (x, y) => {
                    return {
                        l: 100 - ((Math.floor(x / gradient) * gradient) / 360) * 100,
                        s: 100 - ((Math.floor(y / gradient) * gradient) / 360) * 100,
                    };
                };

                selector.element.addEventListener("mousedown", (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    setCurrentColor(toSLCords(x, y));
                    renderPicker();
                });

                sample.element.addEventListener("mousedown", (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const slot = Math.floor(y / 30);
                    if (state.previousColors.length > slot) {
                        const retrieved = state.previousColors.at(-(slot + 1));
                        setCurrentColor(retrieved);
                        renderPicker();
                    }
                });
                const renderPicker = () => {
                    for (let i = 0; i < 360; i += gradient) {
                        slider.ctx.fillStyle = hsl(i, 100, 50);
                        slider.ctx.fillRect(0, i, 30, gradient);
                    }
                    for (
                        let n = 0;
                        n < Math.min(12, state.previousColors.length);
                        n++
                    ) {
                        const { h, s, l } =
                            state.previousColors[
                                state.previousColors.length - n - 1
                            ];
                        sample.ctx.fillStyle = hsl(h, s, l);
                        sample.ctx.fillRect(0, n * 30, 30, 30);
                    }
                    for (let x = 0; x < 360; x += gradient) {
                        for (let y = 0; y < 360; y += gradient) {
                            const { s, l } = toSLCords(x, y);
                            selector.ctx.fillStyle = hsl(
                                state.currentColor.h,
                                s,
                                l
                            );
                            selector.ctx.fillRect(x, y, gradient, gradient);
                        }
                    }
                };
                renderPicker();
            });
        </script>
    </body>
</html>
